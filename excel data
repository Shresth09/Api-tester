<!DOCTYPE html>
<html>
<head>
    <title>USPB-Repos_Jan2025 Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: sans-serif; }
        .chart-container { width: 300px; height: 300px; display: inline-block; margin: 20px; vertical-align: top; }
        #totalEntries { background-color: #f0f0f0; padding: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>USPB-Repos_Jan2025 Data Visualizations</h1>

    <div id="totalEntries"></div>

    <input type="file" id="csvFileInput" accept=".csv">

    <div id="charts"></div>

    <h2>Data Table</h2>
    <table id="dataTable" class="display"></table>

    <script>
        document.getElementById('csvFileInput').addEventListener('change', function(event) {
            const file = event.target.files;
            if (file && file.name === 'USPB-Repos_Jan2025.csv') {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        visualizeData(data);
                    }
                });
            } else {
                alert("Please select the correct file: USPB-Repos_Jan2025.csv");
            }
        });

        function visualizeData(data) {
            document.getElementById('totalEntries').textContent = "Total Entries: " + data.length;
            createCharts(data);
            createDataTable(data);
        }

        function createCharts(data) {
            const chartsDiv = document.getElementById('charts');
            const headers = Object.keys(data);

            headers.forEach(header => {
                const uniqueValues = {};
                data.forEach(row => {
                    const value = row[header] || 'Unknown';
                    uniqueValues[value] = (uniqueValues[value] || 0) + 1;
                });

                if (Object.keys(uniqueValues).length > 1 && Object.keys(uniqueValues).length < 20) {
                    const labels = Object.keys(uniqueValues);
                    const values = Object.values(uniqueValues);

                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    const canvas = document.createElement('canvas');
                    chartContainer.appendChild(canvas);
                    chartsDiv.appendChild(chartContainer);

                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)',
                                    'rgba(192, 192, 192, 0.7)',
                                    'rgba(0, 128, 0, 0.7)',
                                    'rgba(128, 0, 128, 0.7)',
                                    'rgba(0, 0, 128, 0.7)',
                                    'rgba(255, 0, 0, 0.7)',
                                    'rgba(0, 255, 0, 0.7)',
                                    'rgba(0, 0, 255, 0.7)',
                                    'rgba(255, 255, 0, 0.7)',
                                    'rgba(0, 255, 255, 0.7)',
                                    'rgba(255, 0, 255, 0.7)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: header,
                                },
                                datalabels: {
                                    formatter: (value, ctx) => {
                                        let sum = 0;
                                        let dataArr = ctx.chart.data.datasets.data;
                                        dataArr.map(data => {
                                            sum += data;
                                        });
                                        let percentage = (value * 100 / sum).toFixed(2) + "%";
                                        return percentage + "\n(" + value + "/" + sum + ")";
                                    },
                                    color: '#000',
                                    anchor: 'end',
                                    align: 'start',
                                    offset: 10,
                                    borderWidth: 1,
                                    borderColor: '#000',
                                    borderRadius: 25,
                                    backgroundColor: (context) => {
                                        return context.dataset.backgroundColor[context.dataIndex];
                                    },
                                },
                            },
                            elements: {
                                arc: {
                                    borderWidth: 0,
                                },
                            },
                        },
                        plugins: [ChartDataLabels.default]
                    });
                }
            });
        }

        function createDataTable(data) {
            $(document).ready(function() {
                $('#dataTable').DataTable({
                    data: data,
                    columns: Object.keys(data).map(key => ({ title: key, data: key }))
                });
            });
        }
    </script>
</body>
</html>
