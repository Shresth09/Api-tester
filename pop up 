#set($allowedProjectKeys = [])
## Fetch the allowed project keys from the servlet
#set($apiUrl = $request.getContextPath() + "/plugins/servlet/issuecrud?action=getSelectedProjects")
#set($jsonResponse = $action.remote($apiUrl))
#set($allowedProjectKeys = $jsonResponse.split(","))

<div id="plugin-container" style="display: none;">
  <div id="popup-container">
  #if($allowedProjectKeys.contains($project.key))
    <a id="show-popup" class="aui-button">AI-RQM Analysis</a>

    <!-- Modal Structure -->
    <div id="api-modal" class="aui-dialog2 aui-dialog2-medium" role="dialog" aria-hidden="true" style="display:none;">
      <header class="aui-dialog2-header">
        <h2 class="aui-dialog2-header-main">RQM Description Analysis</h2>
        <a class="aui-dialog2-header-close">
          <span class="aui-icon aui-icon-small aui-iconfont-close-dialog">Close</span>
        </a>
      </header>
      <div class="aui-dialog2-content">
        <div id="api-response">Loading data...</div>
      </div>
      <footer class="aui-dialog2-footer">
        <div class="aui-dialog2-footer-actions">
          <button id="close-button" class="aui-button aui-button-primary">Close</button>
        </div>
      </footer>
    </div>
  #else
  #end
  </div>
</div>

<script type="module">
  AJS.toInit(function() {
    jQuery(document).ready(function() {
      initStuff();
    });
  });
</script>

<script type="text/javascript">
  function initStuff() {
    if (AJS.$("#show-popup").length && !AJS.$("#show-popup").data('events-attached')) {
      // Function to extract the issue key
      function getIssueKey() {
        console.log("Extracting issue key...");
        var url = window.location.href;
        var issueKeyPattern = /browse\/([A-Z]+-\d+)/;
        var match = url.match(issueKeyPattern);
        if (match) {
          return match[1];
        }
        var issueKeyElement = AJS.$("#key-val");
        if (issueKeyElement.length) {
          return issueKeyElement.text().trim();
        }
        var selectedIssueKey = AJS.$(".selected-issue-key").text();
        if (selectedIssueKey) {
          return selectedIssueKey.trim();
        }
        return null;
      }

      // Show the modal and fetch API data on button click
      AJS.$("#show-popup").click(function() {
        console.log("Button clicked!");
        var issuekey = getIssueKey();
        if (!issuekey) {
          console.log("Issue key not found.");
          AJS.$("#api-response").html("<p style='color: red; font-weight: bold;'> Issue key not found. </p>");
          AJS.dialog2("#api-modal").show();
          return;
        }

        var jiraApiUrl = AJS.params.baseURL + "/rest/api/2/issue/" + issuekey;
        console.log("Fetching data from Jira API:", jiraApiUrl);

        // Fetch the issue description from Jira
        jQuery.ajax({
          url: jiraApiUrl,
          type: 'GET',
          dataType: 'json',
          success: function(response) {
            console.log("Jira API response received:", response);
            var description = response.fields.description;
            if (!description) {
              console.log("Description not provided in the issue.");
              AJS.$("#api-response").html("<p style='color: red; font-weight: bold;'>