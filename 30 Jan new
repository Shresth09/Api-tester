// Update custom field value after successful API response
function updateCustomFieldValue(issueKey, customFieldId, newValue) {
    var jiraApiUrl = AJS.params.baseURL + "/rest/api/2/issue/" + issueKey;
    var data = {
        "fields": {}
    };
    data.fields[customFieldId] = newValue;

    jQuery.ajax({
        url: jiraApiUrl,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            console.log("Custom field value updated successfully!");
        },
        error: function() {
            console.log("Error updating custom field value");
        }
    });
}

// Your existing success function
jQuery.ajax({
    url: apiurl,
    type: "POST",
    contentType: 'application/json',
    data: payload,
    success: function(apiResponse) {
        console.log("External API response received:", apiResponse);
        var cscore = apiResponse.NA.cscore;
        var messages = apiResponse.NA.message;

        var formattedData = "<p style='font-size: 1.2em; font: Citi-Sans-Text-Regular;'><strong>Description Score:</strong> " + cscore + "</p>" +
            "<p style='font-size: 1.2em; font: Citi-Sans-Text-Regular;'><strong>Action Required:</strong> " + messages.join("<br>") + "</p>";

        AJS.$("#api-response").html(formattedData);
        AJS.dialog2("#api-modal").show();

        // Call the function to update the custom field value
        var issueKey = getIssueKey();
        var customFieldId = 'customfield_10000'; // Replace with your custom field ID
        updateCustomFieldValue(issueKey, customFieldId, cscore);
    },
    error: function(xhr, status, error) {
        console.log("Error in external API call:", status, error);
        AJS.$("#api-response").html("<p style='color: red; font: Citi-Sans-Text-Regular;'>Failed to fetch data. Please verify Configured Endpoint. Status: " + xhr.status + ", Error: " + error + "</p>");
        AJS.dialog2("#api-modal").show();
    }
});










#if ($allowedProjectKeys.contains($project.key))
    <a id="show-popup" class="sui-button">Analyze Description</a>

    <div class="score-display">
        Score: <span id="score-value">Loading...</span>
    </div>

    <!-- Modal Structure -->
    <div id="api-modal" class="aui-dialog2 aui-dialog2-medium" role="dialog" aria-hidden="true" style="display:none;">
        <header class="aui-dialog2-header">
            <h2 class="aui-dialog2-header-main">ROM Description Analysis</h2>
            <a class="aui-dialog2-header-close">
                <span class="aui-icon aui-icon-small aui-iconfont-close-dialog">Close</span>
            </a>
        </header>
        <div class="aui-dialog2-content">
            <div id="api-response">Loading data...</div>
        </div>
        <footer class="aui-dialog2-footer">
            <div class="aui-dialog2-footer-actions">
                <button id="close-button" class="aui-button aui-button-primary">Close</button>
            </div>
        </footer>
    </div>

    <script type="text/javascript">
        function initStuff() {
            // Existing code for button click and other functionalities

            // Ensure the popup button remains responsive
            if (AJS.$("#show-popup").length && !AJS.$("#show-popup").data('events-attached')) {
                AJS.$("#show-popup").click(function() {
                    console.log("Button clicked!");

                    // Additional code to handle popup click event
                    AJS.dialog2("#api-modal").show();
                });

                AJS.$("#show-popup").data('events-attached', true);
            }

            AJS.$("#close-button, aui-dialog2-header-close").on("click", function() {
                AJS.dialog2("#api-modal").hide();
                setTimeout(function() {
                    AJS.$("#api-modal").attr("aria-hidden", "true").hide();
                    AJS.$("#api-response").html("Loading data...");
                }, 300);
            });
        }

        if (typeof jQuery != "undefined") {
            jQuery(document).ready(function() {
                initStuff();
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            initStuff();
            JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED, function() {
                initStuff();
            });
        });
    </script>

    <!-- Separate script tag for fetching and displaying custom field value -->
    <script type="text/javascript">
        jQuery(document).ready(function() {
            function getIssueKey() {
                var url = window.location.href;
                var issueKeyPattern = /browse\/([A-Z]+-\d+)/;
                var match = url.match(issueKeyPattern);

                if (match) {
                    return match[1];
                }

                var issueKeyElement = AJS.$("#key-val");
                if (issueKeyElement.length) {
                    return issueKeyElement.text().trim();
                }

                var selectedIssueKey = AJS.$(".selected-issue-key").text();
                if (selectedIssueKey) {
                    return selectedIssueKey.trim();
                }

                return null;
            }

            function fetchCustomFieldValue(issueKey) {
                var jiraApiUrl = AJS.params.baseURL + "/rest/api/2/issue/" + issueKey;
                jQuery.ajax({
                    url: jiraApiUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        var customFieldId = 'customfield_10000'; // Replace with your custom field ID
                        var scoreValue = response.fields[customFieldId];
                        if (scoreValue != null) {
                            AJS.$("#score-value").text(scoreValue);
                        } else {
                            AJS.$("#score-value").text("Not Set");
                        }
                    },
                    error: function() {
                        AJS.$("#score-value").text("Error fetching data");
                    }
                });
            }

            var issueKey = getIssueKey();
            if (issueKey) {
                fetchCustomFieldValue(issueKey);
            } else {
                AJS.$("#score-value").text("Issue key not found");
            }
        });
    </script>
#else
#end