import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.*;
import org.springframework.web.client.RestTemplate;

import java.util.*;

public class JiraCustomFieldFetcher {

    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper;
    private final String jiraToken;
    private final String jiraBaseUrl;

    public JiraCustomFieldFetcher(RestTemplate restTemplate, ObjectMapper objectMapper, String jiraToken, String jiraBaseUrl) {
        this.restTemplate = restTemplate;
        this.objectMapper = objectMapper;
        this.jiraToken = jiraToken;
        this.jiraBaseUrl = jiraBaseUrl;
    }

    public Map<String, String> storeCustomFieldValues(String issueKey) throws Exception {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + jiraToken);
        headers.set("Accept", MediaType.APPLICATION_JSON_VALUE);
        HttpEntity<String> entity = new HttpEntity<>(headers);

        String urlToSend = jiraBaseUrl + "/rest/api/latest/issue/" + issueKey + "?expand=names";
        ResponseEntity<String> response = restTemplate.exchange(urlToSend, HttpMethod.GET, entity, String.class);

        JsonNode root = objectMapper.readTree(response.getBody());
        JsonNode fieldsNode = root.path("fields");
        JsonNode namesNode = root.path("names");

        // Define lists of custom field names for different types
        List<String> simpleFieldNames = Arrays.asList("Summary", "Description");
        List<String> multiSelectFieldNames = Arrays.asList("Test Type");
        List<String> singleSelectFieldNames = Arrays.asList("Is Automated");

        Map<String, String> simpleFieldMap = getCustomFieldId(namesNode, simpleFieldNames);
        Map<String, String> multiSelectFieldMap = getCustomFieldId(namesNode, multiSelectFieldNames);
        Map<String, String> singleSelectFieldMap = getCustomFieldId(namesNode, singleSelectFieldNames);

        Map<String, String> result = new HashMap<>();
        result.putAll(fetchSimpleTextFields(fieldsNode, simpleFieldMap));
        result.putAll(fetchMultiSelectFields(fieldsNode, multiSelectFieldMap));
        result.putAll(fetchSingleSelectFields(fieldsNode, singleSelectFieldMap));

        return result;
    }

    private Map<String, String> getCustomFieldId(JsonNode namesNode, List<String> fieldNames) {
        Map<String, String> fieldMap = new HashMap<>();
        namesNode.fields().forEachRemaining(entry -> {
            if (fieldNames.contains(entry.getValue().asText())) {
                fieldMap.put(entry.getValue().asText(), entry.getKey()); // <Name, ID>
            }
        });
        return fieldMap;
    }

    private Map<String, String> fetchSimpleTextFields(JsonNode fieldsNode, Map<String, String> fieldMap) {
        Map<String, String> result = new HashMap<>();
        fieldMap.forEach((name, id) -> {
            String value = fieldsNode.path(id).asText(null);
            if (value != null) result.put(name, value);
        });
        return result;
    }

    private Map<String, String> fetchMultiSelectFields(JsonNode fieldsNode, Map<String, String> fieldMap) {
        Map<String, String> result = new HashMap<>();
        fieldMap.forEach((name, id) -> {
            JsonNode arrayNode = fieldsNode.path(id);
            if (arrayNode.isArray()) {
                List<String> values = new ArrayList<>();
                for (JsonNode item : arrayNode) {
                    values.add(item.path("value").asText());
                }
                result.put(name, String.join(" ", values));
            }
        });
        return result;
    }

    private Map<String, String> fetchSingleSelectFields(JsonNode fieldsNode, Map<String, String> fieldMap) {
        Map<String, String> result = new HashMap<>();
        fieldMap.forEach((name, id) -> {
            JsonNode objectNode = fieldsNode.path(id);
            if (objectNode.isObject()) {
                result.put(name, objectNode.path("value").asText());
            }
        });
        return result;
    }
}