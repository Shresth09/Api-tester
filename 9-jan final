<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch and Update URL</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="${contextPath}/s/2.0.1/_/download/batch/com.atlassian.auiplugin:ajs/css/aui.min.css" media="all">
</head>
<body>
    <div class="container">
        <!-- Modal Dialog -->
        <div id="url-config-dialog" class="aui-dialog2 aui-dialog2-medium" role="dialog">
            <header class="aui-dialog2-header">
                <h2 class="aui-dialog2-header-main">AI-RQM URL Configuration</h2>
                <a class="aui-dialog2-header-close">
                    <span class="aui-icon aui-icon-small aui-iconfont-close-dialog">Close</span>
                </a>
            </header>
            <div class="aui-dialog2-content">
                <div class="aui-message aui-message-info">
                    <p><strong>Current URL:</strong> <pre id="currentUrl">Loading...</pre></p>
                </div>
                <div class="update-group">
                    <input type="text" id="newUrl" class="text medium-long-field" placeholder="Enter new API URL">
                </div>
            </div>
            <footer class="aui-dialog2-footer">
                <div class="aui-dialog2-footer-actions">
                    <button class="aui-button aui-button-primary" onclick="updateUrl()">Update URL</button>
                    <button class="aui-button aui-button-link" id="cancel-button">Cancel</button>
                </div>
            </footer>
        </div>

        <script>
            function fetchUrl() {
                const apiUrl = window.location.origin + "/jira/plugins/servlet/issuecrud?action=getUrl";
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Referer': window.location.href,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('currentUrl').textContent = `Current URL: ${data.apiUrl}`;
                    document.getElementById('newUrl').value = data.apiUrl;
                })
                .catch(error => {
                    document.getElementById('currentUrl').textContent = `Error: ${error}`;
                });
            }

            function updateUrl() {
                const newUrl = document.getElementById('newUrl').value;
                const apiUrl = window.location.origin + "/jira/plugins/servlet/issuecrud?action=updateUrl&url=" + newUrl;

                console.log("Updating URL:", newUrl);
                console.log("Request URL:", apiUrl);

                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Referer': window.location.href
                    }
                })
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("Response data:", data);
                    document.getElementById('currentUrl').textContent = `Current URL: ${newUrl}`;
                    document.getElementById('newUrl').value = newUrl;
                    alert('URL updated successfully!');
                    AJS.dialog2("#url-config-dialog").hide(); // Close the dialog
                })
                .catch(error => {
                    console.log("Error occurred:", error);
                    alert(`Error: ${error}`);
                });
            }

            // Automatically fetch the URL when the page loads
            document.addEventListener("DOMContentLoaded", fetchUrl);

            // Open the dialog when the web item is clicked
            AJS.$("#configuration-link").click(function(e) {
                e.preventDefault();
                AJS.dialog2("#url-config-dialog").show();
            });

            // Close the dialog when the cancel button is clicked
            AJS.$("#cancel-button").click(function(e) {
                e.preventDefault();
                AJS.dialog2("#url-config-dialog").hide();
            });
        </script>
    </div>
</body>
</html>